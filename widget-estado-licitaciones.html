<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado Licitaciones</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 20px;
            background-color: transparent;
            color: #37352F;
        }

        .wrapper {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .counter {
            background: linear-gradient(135deg, #f6f8fa 0%, #e8e8e8 100%);
            padding: 30px 20px;
            border-radius: 12px;
            flex: 1;
            min-width: 250px;
            max-width: 280px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .counter:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .counter.processing {
            background: linear-gradient(135deg, #FFF4E0 0%, #FFE4A0 100%);
        }

        .counter.success {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
        }

        .counter.warning {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .icon-wrapper {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
        }

        .counter i {
            font-size: 28px;
            color: #4ad1e5;
        }

        .counter.processing i {
            animation: spin 2s linear infinite;
        }

        .count-title {
            font-size: 48px;
            font-weight: 700;
            margin: 15px 0 5px;
            text-align: center;
            color: #37352F;
        }

        .count-text {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            color: #787774;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            background: #9E9E9E;
            color: #fff;
        }

        .status-badge.active {
            background: #FFC107;
        }

        .status-badge.completed {
            background: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Bloque 1 -->
        <div class="counter" id="bloque1">
            <span class="status-badge" id="badge1">Inactivo</span>
            <div class="icon-wrapper">
                <i class="fas fa-play-circle"></i>
            </div>
            <h2 class="count-title" id="num1">0</h2>
            <p class="count-text">Proceso Iniciado</p>
        </div>

        <!-- Bloque 2 -->
        <div class="counter" id="bloque2">
            <span class="status-badge" id="badge2">Esperando</span>
            <div class="icon-wrapper">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="count-title" id="num2">0</h2>
            <p class="count-text">Registros Procesados</p>
        </div>

        <!-- Bloque 3 -->
        <div class="counter" id="bloque3">
            <span class="status-badge" id="badge3">-</span>
            <div class="icon-wrapper">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h2 class="count-title" id="num3">0</h2>
            <p class="count-text">Registros Omitidos</p>
        </div>
    </div>

    <script>
        const API_URL = 'https://n8n.proterra.info/webhook/widget-status';
        
        function actualizarWidget(data) {
            // Actualizar números
            document.getElementById('num1').textContent = data.iniciado || 0;
            document.getElementById('num2').textContent = data.procesados || 0;
            document.getElementById('num3').textContent = data.duplicados || 0;
            
            // Actualizar clases y badges
            const bloque1 = document.getElementById('bloque1');
            const bloque2 = document.getElementById('bloque2');
            const bloque3 = document.getElementById('bloque3');
            
            // Resetear
            bloque1.className = 'counter';
            bloque2.className = 'counter';
            bloque3.className = 'counter';
            
            if (data.estado === 'procesando') {
                bloque1.classList.add('processing');
                bloque2.classList.add('processing');
                bloque3.classList.add('processing');
                
                document.getElementById('badge1').textContent = 'Activo';
                document.getElementById('badge1').className = 'status-badge active';
                document.getElementById('badge2').textContent = 'Procesando...';
                document.getElementById('badge2').className = 'status-badge active';
                document.getElementById('badge3').textContent = 'Verificando';
                document.getElementById('badge3').className = 'status-badge active';
            } 
            else if (data.estado === 'completado') {
                bloque1.classList.add('success');
                bloque2.classList.add('success');
                if (data.duplicados > 0) {
                    bloque3.classList.add('warning');
                }
                
                document.getElementById('badge1').textContent = 'Completado';
                document.getElementById('badge1').className = 'status-badge completed';
                document.getElementById('badge2').textContent = 'Finalizado';
                document.getElementById('badge2').className = 'status-badge completed';
                document.getElementById('badge3').textContent = data.duplicados > 0 ? 'Omitidos' : 'OK';
                document.getElementById('badge3').className = 'status-badge completed';
                
                // Reset después de 5 segundos
                setTimeout(() => {
                    fetch(API_URL.replace('widget-status', 'widget-update'), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({reset: true})
                    });
                }, 5000);
            }
            else {
                document.getElementById('badge1').textContent = 'Inactivo';
                document.getElementById('badge2').textContent = 'Esperando';
                document.getElementById('badge3').textContent = '-';
            }
        }
        
        async function obtenerEstado() {
            try {
                const res = await fetch(API_URL + '?t=' + Date.now());
                const data = await res.json();
                actualizarWidget(data);
            } catch (err) {
                console.log('Esperando...', err);
            }
        }
        
        // Actualizar cada 2 segundos
        setInterval(obtenerEstado, 2000);
        obtenerEstado();
        
        // Función para testing manual
        window.test = function(iniciado, procesados, duplicados, estado) {
            actualizarWidget({
                estado: estado || 'procesando',
                iniciado: iniciado,
                procesados: procesados,
                duplicados: duplicados
            });
        };
    </script>
</body>
</html>

